#!/usr/bin/env python
import pefile
import sys
import os
import os.path
from os import path

#This function checks the valid path of the file and prints the result
def checkFilePath(file):
    if path.exists(file):
        return
    print("file does not exist, terminating program")
    exit(1)

#This function should check if your input starts with 0x followed by valid hex or the input is a digit and prints the result
def checkHexInput(hexInput):
    if hexInput.isdigit():
        return
    elif ishex(hexInput) and hexInput.startswith("0x"):
        return
    else:
        print("not a valid input, terminating program")
        exit(1)

#good an idea for checking valid hexdecimal digits from python-forum.io
def ishex(s):
    try:
        n = int(s,16)
        return True
    except ValueError:
        return False

#function to convert the TargetVirtualAddress to the TargetFilePointer
def conversion(vparameter):
    if vparameter.isdigit():
        vparameter = hex(int(vparameter))

    for section in pe.sections:
        lowerbound = section.VirtualAddress + pe.OPTIONAL_HEADER.ImageBase

        upperbound = lowerbound + section.Misc_VirtualSize

        thisisflag = False
        if upperbound > int(vparameter,16) and lowerbound < int(vparameter,16):
            thisisflag = True
            ofset = int(vparameter,16) - section.VirtualAddress - pe.OPTIONAL_HEADER.ImageBase
            targetfilepointer = ofset + section.PointerToRawData
            print(vparameter.lower() + " -> " + hex(targetfilepointer))
            return

    if thisisflag == False:
        print(vparameter.lower() + " -> " + "??")

#main function
if __name__ == "__main__":

#These vars are the first two CLI arguments(FilePath,TargetVirtualAddress)
    apath = sys.argv[1]
    virtualaddress = sys.argv[2]
#####################################################################
    checkFilePath(apath)
    checkHexInput(virtualaddress)
    pe = pefile.PE(apath)
    conversion(virtualaddress)